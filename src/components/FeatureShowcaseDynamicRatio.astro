---
import "../styles/feature-showcase.css";

type Side = 'left' | 'right';
type Anim =
  | 'slide-left' | 'slide-right' | 'slide-up' | 'slide-down'
  | 'zoom-in' | 'fade-in' | 'blur-in' | 'rotate-in' | 'scale-up' | 'lift-in';

interface CarouselImage {
  light: string;
  dark?: string;
  alt: string;
  width?: number;
  height?: number;
}
interface Item {
  title: string;
  text: string;
  alt: string;
  img?: string;
  imgLight?: string;
  imgDark?: string;
  carousel?: boolean;
  carouselImages?: CarouselImage[];
  side?: Side;
  mediaAnim?: Anim;
  contentAnim?: Anim;
  altBg?: boolean;
  mediaWide?: boolean;
  width?: number;
  height?: number;
  autoplayMs?: number;
  pauseOnHover?: boolean;
  fullscreenButton?: boolean;
}

const { items = [] as Item[], defer = false } =
  Astro.props as { items?: Item[]; defer?: boolean };

const cycle: Anim[] = ["slide-left","slide-right","slide-up","zoom-in","lift-in","scale-up"];

function isValidString(v: any): v is string {
  return typeof v === 'string' && v.trim().length > 0;
}
function computeWebpPath(path?: string): string {
  if (!path || !/\.(png|jpe?g)$/i.test(path)) return '';
  return path.replace(/\.(png|jpe?g)$/i, '.webp');
}
function buildRowClasses(it: Item, side: Side): string {
  return [
    `feature-${side}`,
    it.altBg ? 'feature-alt' : '',
    it.mediaWide ? 'feature-media-lg' : ''
  ].filter(Boolean).join(' ');
}
function buildSizes(it: Item): string {
  return it.mediaWide
    ? '(min-width:1200px) 60vw, (min-width:900px) 50vw, 92vw'
    : '(min-width:900px) 42vw, 94vw';
}
---

<section class={`section showcase-section ${defer ? 'defer' : ''}`}>
  <div class="showcase-bg"></div>
  <div class="showcase-inner">
    {
      items.length === 0
        ? <p class="muted center" style="margin:40px 0;">(No hay feature configurado)</p>
        : items.map((it, i) => {
            if (!isValidString(it?.title) || !isValidString(it?.text)) {
              return (
                <article class="feature-row feature-left">
                  <div class="feature-row-inner">
                    <div class="feature-content">
                      <h3 style="color:#c00;">Item inválido #{i+1}</h3>
                      <p class="muted small">Falta title o text.</p>
                    </div>
                  </div>
                </article>
              );
            }

            const side: Side = it.side || 'left'; // puedes cambiar a (i % 2 ? 'right' : 'left') si quieres alternar
            const mediaAnim = it.mediaAnim || cycle[i % cycle.length];
            const contentAnim = it.contentAnim || cycle[(i + 1) % cycle.length];
            const mediaFirst = side === 'left';

            const width = it.width || 980;
            const height = it.height || 600;
            const sizes = buildSizes(it);
            const rowClasses = buildRowClasses(it, side);

            const isCarousel = Boolean(it.carousel && it.carouselImages && it.carouselImages.length > 0);
            const showFullscreenBtn = it.fullscreenButton !== false;

            let mediaVNode;

            if (isCarousel) {
              const carouselId = `carousel-${Math.random().toString(36).slice(2,9)}`;
              const autoplayMs = (it.autoplayMs && it.autoplayMs > 500) ? it.autoplayMs : 4500;
              const pauseOnHover = it.pauseOnHover !== false;

              mediaVNode = (
                <div class="feature-media reveal"
                  data-reveal
                  data-anim={mediaAnim}
                  data-stagger="0"
                  style="--stagger-delay:0s;"
                >
                  <div
                    class="feature-media-inner carousel-root"
                    data-carousel
                    data-id={carouselId}
                    data-count={it.carouselImages!.length}
                    data-autoplay={String(autoplayMs)}
                    data-pause-hover={String(pauseOnHover)}
                    style={`aspect-ratio:${width}/${height};`}
                  >
                    <div class="carousel-track" aria-live="polite">
                      {
                        it.carouselImages!.map((imgObj, idx) => {
                          const lightSrc = imgObj.light;
                          const darkSrc  = imgObj.dark;
                          const altImg   = imgObj.alt || it.alt || it.title;
                          const wImg     = imgObj.width || width;
                          const hImg     = imgObj.height || height;
                          const lightWebp = computeWebpPath(lightSrc);
                          const darkWebp  = computeWebpPath(darkSrc);
                          return (
                            <div
                              class={`carousel-slide ${idx===0?'is-active':''}`}
                              role="group"
                              aria-roledescription="slide"
                              aria-label={`${idx+1} de ${it.carouselImages!.length}`}
                              data-index={idx}
                            >
                              <picture class="theme-light">
                                {lightWebp && <source srcset={lightWebp} type="image/webp" />}
                                {lightSrc && <img
                                  src={lightSrc}
                                  alt={altImg}
                                  loading={idx===0 ? "eager" : "lazy"}
                                  decoding="async"
                                  width={wImg}
                                  height={hImg}
                                  sizes={sizes}
                                  class="feature-contain theme-light"
                                /> }
                              </picture>
                              {darkSrc && (
                                <picture class="theme-dark">
                                  {darkWebp && <source srcset={darkWebp} type="image/webp" />}
                                  <img
                                    src={darkSrc}
                                    alt={altImg}
                                    loading="lazy"
                                    decoding="async"
                                    width={wImg}
                                    height={hImg}
                                    sizes={sizes}
                                    class="feature-contain theme-dark"
                                  />
                                </picture>
                              )}
                            </div>
                          );
                        })
                      }
                    </div>

                    <div class="carousel-ui" aria-label="Controles carrusel">
                      <button type="button" class="carousel-btn prev" aria-label="Anterior" data-carousel-prev>‹</button>
                      <button type="button" class="carousel-btn next" aria-label="Siguiente" data-carousel-next>›</button>
                      {showFullscreenBtn && (
                        <button
                          type="button"
                          class="carousel-btn fullscreen"
                          aria-label="Pantalla completa"
                          data-carousel-fullscreen
                        >⤢</button>
                      )}
                      <div class="carousel-dots" role="tablist">
                        {it.carouselImages!.map((_, idx) => (
                          <button
                            type="button"
                            role="tab"
                            aria-selected={idx===0 ? "true":"false"}
                            aria-label={`Mostrar imagen ${idx+1}`}
                            class={`carousel-dot ${idx===0?'is-active':''}`}
                            data-carousel-dot
                            data-index={idx}
                          />
                        ))}
                      </div>
                    </div>
                  </div>
                </div>
              );
            } else {
              const lightSrc = it.imgLight || it.img;
              const darkSrc  = it.imgDark || it.img;
              const lightWebp = computeWebpPath(lightSrc);
              const darkWebp  = computeWebpPath(darkSrc);

              mediaVNode = (
                <div class="feature-media reveal"
                  data-reveal
                  data-anim={mediaAnim}
                  data-stagger="0"
                  style="--stagger-delay:0s;"
                >
                  <div class="feature-media-inner dynamic-ratio" data-zoomable style={`aspect-ratio:${width}/${height};`}>
                    {lightSrc && (
                      <picture class={darkSrc ? "theme-light" : ""}>
                        {lightWebp && <source srcset={lightWebp} type="image/webp" />}
                        <img
                          src={lightSrc}
                          alt={it.alt || it.title}
                          loading="lazy"
                          decoding="async"
                          width={width}
                          height={height}
                          sizes={sizes}
                          class="feature-contain"
                        />
                      </picture>
                    )}
                    {darkSrc && (
                      <picture class="theme-dark">
                        {darkWebp && <source srcset={darkWebp} type="image/webp" />}
                        <img
                          src={darkSrc}
                          alt={it.alt || it.title}
                          loading="lazy"
                          decoding="async"
                          width={width}
                          height={height}
                          sizes={sizes}
                          class="feature-contain theme-dark"
                        />
                      </picture>
                    )}
                  </div>
                </div>
              );
            }

            const contentVNode = (
              <div class="feature-content reveal"
                data-reveal
                data-anim={contentAnim}
                data-stagger="1"
                style="--stagger-delay:.14s;"
              >
                <h3>{it.title}</h3>
                <p>{it.text}</p>
              </div>
            );

            return (
              <article class={`feature-row ${rowClasses}`}>
                <div class="feature-row-inner">
                  {mediaFirst ? (<>{mediaVNode}{contentVNode}</>) : (<>{contentVNode}{mediaVNode}</>)}
                </div>
              </article>
            );
          })
    }
  </div>
</section>

<script is:inline>
(() => {
  const reduce = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
  const reveals = document.querySelectorAll('[data-reveal]');
  if (reduce) {
    reveals.forEach(e => e.classList.add('is-visible'));
  } else {
    const io = new IntersectionObserver((entries) => {
      for (const e of entries) {
        if (e.isIntersecting) e.target.classList.add('is-visible');
      }
    }, { threshold: .25 });
    reveals.forEach(e => io.observe(e));
  }

  const carousels = document.querySelectorAll('.carousel-root[data-carousel]');
  carousels.forEach(root => {
    const slides = Array.from(root.querySelectorAll('.carousel-slide'));
    if(!slides.length) return;
    const dots = Array.from(root.querySelectorAll('[data-carousel-dot]'));
    const btnPrev = root.querySelector('[data-carousel-prev]');
    const btnNext = root.querySelector('[data-carousel-next]');
    const btnFs  = root.querySelector('[data-carousel-fullscreen]');
    let index=0;
    const AUTOPLAY=parseInt(root.getAttribute('data-autoplay')||'4500',10);
    const PAUSE_HOVER=root.getAttribute('data-pause-hover')==='true';
    let timer=null,isPaused=false;

    function setActive(n){
      if(n<0)n=slides.length-1;
      if(n>=slides.length)n=0;
      slides.forEach((s,i)=>s.classList.toggle('is-active',i===n));
      dots.forEach((d,i)=>{
        d.classList.toggle('is-active',i===n);
        d.setAttribute('aria-selected',i===n?'true':'false');
        d.tabIndex=i===n?0:-1;
      });
      index=n;
      prefetchNext(root,index);
    }
    function next(){setActive(index+1);}
    function prev(){setActive(index-1);}
    function start(){ if(reduce) return; stop(); timer=setInterval(()=>{if(!isPaused)next();},AUTOPLAY); }
    function stop(){ if(timer){clearInterval(timer);timer=null;} }

    dots.forEach(d=>{
      d.addEventListener('click',e=>{
        e.preventDefault();
        setActive(parseInt(d.getAttribute('data-index')||'0',10));
      });
    });
    btnPrev?.addEventListener('click',e=>{e.preventDefault();prev();});
    btnNext?.addEventListener('click',e=>{e.preventDefault();next();});
    if(PAUSE_HOVER){
      root.addEventListener('mouseenter',()=>{isPaused=true;});
      root.addEventListener('mouseleave',()=>{isPaused=false;});
    }
    root.addEventListener('focusin',()=>{isPaused=true;});
    root.addEventListener('focusout',()=>{isPaused=false;});

    let startX=0,touching=false;
    root.addEventListener('touchstart',e=>{
      if(e.touches.length===1){startX=e.touches[0].clientX;touching=true;}
    },{passive:true});
    root.addEventListener('touchend',e=>{
      if(!touching)return;
      const diff=e.changedTouches[0].clientX-startX;
      if(Math.abs(diff)>40){ diff<0?next():prev(); }
      touching=false;
    },{passive:true});

    setActive(0);
    start();

    btnFs?.addEventListener('click',(e)=>{
      e.preventDefault();
      openFullscreen(root,index);
    });
  });

  // Fullscreen overlay (reutilizado)
  let overlay = document.querySelector('.fs-overlay');
  if(!overlay){
    overlay = document.createElement('div');
    overlay.className='fs-overlay';
    overlay.setAttribute('tabindex','-1');
    document.body.appendChild(overlay);
  }
  overlay.setAttribute('role','dialog');
  overlay.setAttribute('aria-modal','true');

  let fsState = { root:null, slides:[], index:0 };

  function renderFullscreen(){
    overlay.innerHTML='';
    const slide = fsState.slides[fsState.index];
    if(!slide) return;
    const imgLight = slide.querySelector('picture.theme-light img');
    const imgDark  = slide.querySelector('picture.theme-dark img');
    const useDark = document.documentElement.classList.contains('dark-theme');
    const activeImg = (useDark && imgDark) ? imgDark : imgLight || imgDark;
    if(!activeImg) return;
    const img = document.createElement('img');
    img.src = activeImg.currentSrc || activeImg.src;
    img.alt = activeImg.alt || '';
    overlay.appendChild(img);

    const controls = document.createElement('div');
    controls.className='fs-controls';
    controls.innerHTML=`
      <button type="button" class="fs-btn fs-prev" aria-label="Anterior">‹</button>
      <button type="button" class="fs-btn fs-next" aria-label="Siguiente">›</button>
      <button type="button" class="fs-btn fs-close" aria-label="Cerrar">✕</button>
    `;
    overlay.appendChild(controls);
    prefetchNext(fsState.root, fsState.index, true);
  }

  function openFullscreen(root,index){
    const slides = Array.from(root.querySelectorAll('.carousel-slide'));
    if(!slides.length) return;
    fsState.root = root;
    fsState.slides = slides;
    fsState.index = index;
    renderFullscreen();
    overlay.classList.add('is-open');
    document.body.classList.add('fs-zoom-active');
    overlay.focus();
  }
  function closeFullscreen(){
    overlay.classList.remove('is-open');
    document.body.classList.remove('fs-zoom-active');
  }
  function nextFs(){
    fsState.index = (fsState.index + 1) % fsState.slides.length;
    renderFullscreen();
  }
  function prevFs(){
    fsState.index = (fsState.index - 1 + fsState.slides.length) % fsState.slides.length;
    renderFullscreen();
  }

  overlay.addEventListener('click',(e)=>{
    if(e.target.classList.contains('fs-prev')) { e.stopPropagation(); prevFs(); }
    else if(e.target.classList.contains('fs-next')) { e.stopPropagation(); nextFs(); }
    else if(e.target.classList.contains('fs-close')) { e.stopPropagation(); closeFullscreen(); }
    else { closeFullscreen(); }
  });
  document.addEventListener('keydown',(e)=>{
    if(!overlay.classList.contains('is-open')) return;
    if(e.key==='Escape'){ e.preventDefault(); closeFullscreen(); }
    else if(e.key==='ArrowRight'){ e.preventDefault(); nextFs(); }
    else if(e.key==='ArrowLeft'){ e.preventDefault(); prevFs(); }
  });

  function prefetchNext(root,currentIndex,fullscreen=false){
    try{
      const slides=Array.from(root.querySelectorAll('.carousel-slide'));
      if(!slides.length)return;
      const nextSlide = slides[(currentIndex+1)%slides.length];
      if(!nextSlide)return;
      const imgLight = nextSlide.querySelector('picture.theme-light img') || nextSlide.querySelector('img');
      if(!imgLight)return;
      const src=imgLight.getAttribute('src');
      if(!src)return;
      const key='pf-'+src+(fullscreen?'-fs':'');
      if(!document.querySelector('link[data-prefetch="'+key+'"]')){
        const link=document.createElement('link');
        link.rel='prefetch';
        link.href=src;
        link.as='image';
        link.setAttribute('data-prefetch',key);
        document.head.appendChild(link);
      }
    }catch{}
  }
})();
</script>