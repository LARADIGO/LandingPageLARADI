---
import "../styles/faq.css";

/**
 * FaqSection.astro
 * - Acordeón con <details>.
 * - Marcado FAQPage (JSON-LD) para SEO.
 * - Controles (expandir / colapsar) siempre visibles salvo data-expand-collapse="false".
 * - JSON-LD inyectado con set:html para evitar plantillas sin evaluar.
 */
const {
  title = "Preguntas frecuentes",
  description = "",
  items = [],
  defer = false,
  disableSchema = false,
  ...attrs
} = Astro.props as {
  title?: string;
  description?: string;
  items?: { question: string; answer: string }[];
  defer?: boolean;
  disableSchema?: boolean;
  [k: string]: any
};

function slugify(str: string) {
  return str
    .toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/^-+|-+$/g, "")
    .substring(0, 64);
}

const hashPrefix = attrs['data-hash-prefix'] || 'faq-';
const prepared = items.map((it, i) => ({
  ...it,
  id: hashPrefix + (slugify(it.question) || i)
}));

const shouldRenderSchema = !disableSchema && prepared.length > 0;
const faqSchema = shouldRenderSchema ? {
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "mainEntity": prepared.map(entry => ({
    "@type": "Question",
    "name": entry.question,
    "acceptedAnswer": {
      "@type": "Answer",
      "text": entry.answer
    }
  }))
} : null;

const faqJson = shouldRenderSchema ? JSON.stringify(faqSchema) : "";
---

<section id="faq" class={`section faq-section ${defer ? 'defer' : ''}`}>
  <div class="container">
    <h2 class="h2 center">{title}</h2>
    {description && <p class="lead center max-680">{description}</p>}

    <div class="center" style="margin:0 0 18px;">
      <span id="faq-count" class="muted small"></span>
    </div>

    <div class="faq-controls center">
      <button type="button" class="btn btn-sm faq-expand-all" data-analytics="faq_expand_all">Expandir todo</button>
      <button type="button" class="btn btn-sm btn-ghost faq-collapse-all" data-analytics="faq_collapse_all">Colapsar todo</button>
    </div>

    <div
      class="faq-enhanced"
      {...attrs}
      data-component="faq"
      data-hash-prefix={hashPrefix}
      data-length={prepared.length}
    >
      {prepared.map((item, idx) => (
        <details class="faq-item" id={item.id} data-index={idx}>
          <summary>
            <span class="faq-icon" aria-hidden="true">
              <!-- Flecha: derecha (cerrado) -> rota 90º abajo (abierto) -->
              <span class="faq-glyph">▸</span>
            </span>
            <span class="faq-question">{item.question}</span>
          </summary>
          <div class="faq-panel">
            <div class="faq-answer">
              <p>{item.answer}</p>
            </div>
          </div>
        </details>
      ))}
    </div>
  </div>

  {shouldRenderSchema && (
    <script type="application/ld+json" is:inline set:html={faqJson}></script>
  )}
</section>

<script is:inline>
(function(){
  try {
    const root = document.querySelector('[data-component="faq"]');
    if(!root) return;

    const items = Array.from(root.querySelectorAll('.faq-item'));
    if(!items.length) return;

    // Config
    const accordion   = root.dataset.accordion === 'true';
    const persist     = !accordion && root.dataset.persist === 'true';
    const autoscroll  = root.dataset.autoscroll === 'true';
    const hashPrefix  = root.dataset.hashPrefix || 'faq-';
    const counterSel  = root.dataset.counterTarget || '#faq-count';
    const scrollBlock = root.dataset.scrollBlock || 'center';
    const expandCollapseAttr = root.dataset.expandCollapse;
    const expandCollapse = expandCollapseAttr !== 'false';

    const section      = root.closest('.faq-section') || document;
    const counterTarget= section.querySelector(counterSel);
    const controlsWrap = section.querySelector('.faq-controls');

    if(controlsWrap && !expandCollapse){
      controlsWrap.style.display='none';
    } else if (controlsWrap) {
      controlsWrap.style.display='';
    }

    // Persistencia
    const LS_KEY = 'faqOpenIds';
    const loadPersisted = () => {
      if(!persist) return [];
      try { return JSON.parse(localStorage.getItem(LS_KEY) || '[]'); } catch { return []; }
    };
    const savePersisted = (ids) => {
      if(!persist) return;
      try { localStorage.setItem(LS_KEY, JSON.stringify(ids)); } catch {}
    };

    // Estado inicial
    const currentHash = decodeURIComponent(location.hash.replace('#',''));
    const toOpen = new Set();
    if(currentHash && currentHash.startsWith(hashPrefix)){
      const match = items.find(d=>d.id===currentHash);
      if(match) toOpen.add(match.id);
    } else {
      const persisted = loadPersisted();
      if(persisted.length){
        persisted.forEach(id=>toOpen.add(id));
      } else {
        const defaultOpenRaw = root.dataset.defaultOpen || '';
        const defaultIdx = defaultOpenRaw.split(',')
          .map(s=>s.trim()).filter(Boolean)
          .map(s=>parseInt(s,10)).filter(n=>!isNaN(n));
        defaultIdx.forEach(i => {
          const det = items[i];
          if(det) toOpen.add(det.id);
        });
      }
    }

    // Inicializar sin animación (ya no cambiamos el glifo por texto)
    items.forEach(d => {
      const panel = d.querySelector('.faq-panel');
      if(!panel) return;
      if(toOpen.has(d.id)){
        d.setAttribute('open','');
        panel.style.height='auto';
        panel.style.opacity='1';
      } else {
        d.removeAttribute('open');
        panel.style.height='0px';
        panel.style.opacity='0';
        panel.style.overflow='hidden';
      }
    });

    function updateCounter(){
      if(!counterTarget) return;
      const openCount = items.filter(d=>d.open).length;
      const total = items.length;
      counterTarget.textContent = openCount
        ? `Abiertas: ${openCount}/${total}`
        : `Sin preguntas abiertas (${total})`;
    }
    updateCounter();

    function animate(details, opening){
      const panel = details.querySelector('.faq-panel');
      if(!panel) return;
      const reduce = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      panel.style.overflow='hidden';
      if(opening){
        if(reduce){
          panel.style.height='auto'; panel.style.opacity='1'; return;
        }
        panel.style.height='0px'; panel.style.opacity='0';
        requestAnimationFrame(()=>{
          panel.style.transition='height .34s cubic-bezier(.25,.9,.25,1), opacity .30s ease';
          panel.style.height=panel.scrollHeight+'px';
          panel.style.opacity='1';
        });
        panel.addEventListener('transitionend', function end(e){
          if(e.propertyName==='height'){
            panel.style.height='auto';
            panel.style.overflow='';
            panel.removeEventListener('transitionend', end);
          }
        });
      } else {
        if(reduce){
          panel.style.height='0px'; panel.style.opacity='0'; return;
        }
        panel.style.height=panel.scrollHeight+'px'; panel.style.opacity='1';
        requestAnimationFrame(()=>{
          panel.style.transition='height .28s ease, opacity .26s ease';
          panel.style.height='0px';
          panel.style.opacity='0';
        });
        panel.addEventListener('transitionend', function end(e){
          if(e.propertyName==='height'){
            panel.style.overflow='';
            panel.removeEventListener('transitionend', end);
          }
        });
      }
    }

    function openItem(details,{scroll=true, updateHash=true, fireEvt=true}={}){
      if(details.open) return;
      if(accordion){
        items.forEach(d=>{ if(d!==details && d.open) closeItem(d,{updateHash:false, fireEvt:false}); });
      }
      details.setAttribute('open','');
      animate(details,true);
      if(updateHash) history.replaceState(null,'','#'+details.id);
      if(scroll && autoscroll) details.scrollIntoView({behavior:'smooth', block:scrollBlock});
      if(fireEvt) sendGA('faq_open', details);
    }

    function closeItem(details,{updateHash=true, fireEvt=true}={}){
      if(!details.open) return;
      details.removeAttribute('open');
      animate(details,false);
      if(updateHash && location.hash==='#'+details.id) history.replaceState(null,'','#');
      if(fireEvt) sendGA('faq_close', details);
    }

    function persistState(){
      if(!persist) return;
      const openIds = items.filter(d=>d.open).map(d=>d.id);
      savePersisted(openIds);
    }

    function sendGA(eventName, details){
      const gtag = window.gtag || function(){};
      try {
        const question = (details.querySelector('.faq-question')?.textContent || '').trim().slice(0,120);
        const index = parseInt(details.dataset.index || '-1',10);
        gtag('event', eventName, {
          question,
          faq_id: details.id||'',
          index,
          page_path: location.pathname,
          transport_type:'beacon'
        });
      } catch {}
    }

    // Eventos sobre cada summary
    items.forEach(d=>{
      const summary = d.querySelector('summary');
      summary?.addEventListener('click', e=>{
        e.preventDefault();
        d.open ? closeItem(d) : openItem(d);
        persistState(); updateCounter();
      });
      summary?.addEventListener('keydown', e=>{
        if(e.key==='Enter' || e.key===' '){
          e.preventDefault();
          d.open ? closeItem(d) : openItem(d);
          persistState(); updateCounter();
        }
      });
    });

    // Expandir / Colapsar global
    const controlsWrap = (root.closest('.faq-section') || document).querySelector('.faq-controls');
    if(controlsWrap && (root.dataset.expandCollapse !== 'false')){
      const btnExpand = controlsWrap.querySelector('.faq-expand-all');
      const btnCollapse = controlsWrap.querySelector('.faq-collapse-all');
      btnExpand?.addEventListener('click', ()=>{
        items.forEach(d=>openItem(d,{scroll:false, updateHash:false}));
        persistState(); updateCounter();
        const gtag = window.gtag || function(){};
        gtag('event','faq_expand_all',{page_path:location.pathname, transport_type:'beacon'});
      });
      btnCollapse?.addEventListener('click', ()=>{
        items.forEach(d=>closeItem(d,{updateHash:false}));
        persistState(); updateCounter();
        const gtag = window.gtag || function(){};
        gtag('event','faq_collapse_all',{page_path:location.pathname, transport_type:'beacon'});
      });
    }

    // Scroll inicial si llegó con hash
    const currentHash = decodeURIComponent(location.hash.replace('#',''));
    if(currentHash){
      const target = items.find(d=>d.id===currentHash);
      if(target && autoscroll){
        requestAnimationFrame(()=>{ target.scrollIntoView({behavior:'smooth', block:scrollBlock}); });
      }
    }
  } catch(err){
    console.error('[faq] init error', err);
  }
})();
</script>