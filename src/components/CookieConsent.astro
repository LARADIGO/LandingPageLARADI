---
import "../styles/cookie-consent.css";
/**
 * Banner Consent Mode GA4 con expiración 7 días.
 */
---
<div id="cookie-consent" class="cc-wrap" data-state="init" aria-live="polite">
  <div class="cc-card">
    <div class="cc-text">
      Usamos analítica de Google (GA4) para mejorar el sitio. Puedes aceptar o rechazar las cookies de analítica.
      <a href="/politica-privacidad" class="cc-link">Más info</a>
    </div>
    <div class="cc-actions">
      <button class="cc-btn cc-ghost" data-action="reject" type="button">Rechazar</button>
      <button class="cc-btn" data-action="accept" type="button">Aceptar</button>
    </div>
    <button class="cc-manage hp" data-action="manage" type="button" aria-label="Cambiar preferencia de cookies">
      Cambiar preferencia
    </button>
  </div>
</div>

<script is:inline>
(() => {
  const KEY = 'cookie_consent';
  const EXP_MS = 7 * 24 * 60 * 60 * 1000;

  function gtag(){ (window.dataLayer = window.dataLayer || []).push(arguments); }
  function now(){ return Date.now(); }

  function load() {
    try {
      const raw = localStorage.getItem(KEY);
      if (!raw) return null;
      const obj = JSON.parse(raw);
      if (!obj || !obj.value || !obj.ts) return null;
      if (now() - obj.ts > EXP_MS) return null;
      return obj;
    } catch (e) {
      return null;
    }
  }

  function save(value) {
    try {
      localStorage.setItem(KEY, JSON.stringify({ value: value, ts: now() }));
    } catch (e) {}
  }

  function apply(value) {
    var consent = value === 'accepted'
      ? { analytics_storage: 'granted', ad_user_data: 'denied', ad_personalization: 'denied', ad_storage: 'denied' }
      : { analytics_storage: 'denied',  ad_user_data: 'denied', ad_personalization: 'denied', ad_storage: 'denied' };
    gtag('consent', 'update', consent);
  }

  document.addEventListener('DOMContentLoaded', function() {
    var wrap = document.getElementById('cookie-consent');
    if (!wrap) return;

    var manageBtn = wrap.querySelector('.cc-manage');

    var stored = load();
    if (stored) {
      wrap.setAttribute('data-state', 'done');
      if (manageBtn) manageBtn.classList.remove('hp');
      apply(stored.value);
    } else {
      wrap.setAttribute('data-state', 'ask');
      if (manageBtn) manageBtn.classList.add('hp');
    }

    wrap.addEventListener('click', function(ev) {
      var target = ev.target;
      var btn = target.closest ? target.closest('[data-action]') : null;
      if (!btn) return;

      var action = btn.getAttribute('data-action');
      if (action === 'accept') {
        save('accepted'); apply('accepted');
        wrap.setAttribute('data-state', 'done');
        if (manageBtn) manageBtn.classList.remove('hp');
      } else if (action === 'reject') {
        save('rejected'); apply('rejected');
        wrap.setAttribute('data-state', 'done');
        if (manageBtn) manageBtn.classList.remove('hp');
      } else if (action === 'manage') {
        wrap.setAttribute('data-state', 'ask');
        if (manageBtn) manageBtn.classList.add('hp');
      }
    });
  });
})();
</script>