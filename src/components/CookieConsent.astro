---
import "../styles/cookie-consent.css";
/**
 * Banner Consent Mode GA4 + Google Ads.
 * Expira a los 7 días; al aceptar se concede analytics y ads básicas.
 * Ajusta mensaje para reflejar Ads si procede.
 */
---
<div id="cookie-consent" class="cc-wrap" data-state="init" aria-live="polite">
  <div class="cc-card">
    <div class="cc-text">
      Usamos analítica (GA4) y medición de conversiones (Google Ads) para mejorar y conocer el rendimiento.
      Puedes aceptar o rechazar las cookies de medición.
      <a href="/politica-privacidad" class="cc-link">Más info</a>
    </div>
    <div class="cc-actions">
      <button class="cc-btn cc-ghost" data-action="reject" type="button">Rechazar</button>
      <button class="cc-btn" data-action="accept" type="button">Aceptar</button>
    </div>
    <button class="cc-manage hp" data-action="manage" type="button" aria-label="Cambiar preferencia de cookies">
      Cambiar preferencia
    </button>
  </div>
</div>

<script is:inline>
(() => {
  const KEY = 'cookie_consent_v2';
  const EXP_MS = 7 * 24 * 60 * 60 * 1000;

  function gtag(){ (window.dataLayer = window.dataLayer || []).push(arguments); }
  const now = () => Date.now();

  function load(){
    try {
      const raw = localStorage.getItem(KEY);
      if(!raw) return null;
      const obj = JSON.parse(raw);
      if(!obj || !obj.value || !obj.ts) return null;
      if(now() - obj.ts > EXP_MS) return null;
      return obj;
    } catch { return null; }
  }

  function save(value){
    try { localStorage.setItem(KEY, JSON.stringify({ value, ts: now() })); } catch {}
  }

  function apply(value){
    // Ajusta si quieres permitir personalización de anuncios
    if(value === 'accepted'){
      gtag('consent','update',{
        analytics_storage:'granted',
        ad_storage:'granted',
        ad_user_data:'denied',
        ad_personalization:'denied'
      });
    } else {
      gtag('consent','update',{
        analytics_storage:'denied',
        ad_storage:'denied',
        ad_user_data:'denied',
        ad_personalization:'denied'
      });
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    const wrap = document.getElementById('cookie-consent');
    if(!wrap) return;
    const manageBtn = wrap.querySelector('.cc-manage');

    const stored = load();
    if(stored){
      wrap.dataset.state = 'done';
      manageBtn && manageBtn.classList.remove('hp');
      apply(stored.value);
    } else {
      wrap.dataset.state = 'ask';
      manageBtn && manageBtn.classList.add('hp');
    }

    wrap.addEventListener('click', (ev) => {
      const btn = ev.target.closest?.('[data-action]');
      if(!btn) return;
      const action = btn.getAttribute('data-action');
      if(action === 'accept'){
        save('accepted'); apply('accepted');
        wrap.dataset.state = 'done';
        manageBtn && manageBtn.classList.remove('hp');
      } else if(action === 'reject'){
        save('rejected'); apply('rejected');
        wrap.dataset.state = 'done';
        manageBtn && manageBtn.classList.remove('hp');
      } else if(action === 'manage'){
        wrap.dataset.state = 'ask';
        manageBtn && manageBtn.classList.add('hp');
      }
    });
  });
})();
</script>