---
import "@styles/diorama.css";

interface Props{
  title?: string; subtitle?: string;
  ctaText?: string; ctaHref?: string; cta2Text?: string; cta2Href?: string;
  imageSrc?: string;
  splineUrl?: string;
  imageWidth?: number;
  imageHeight?: number;
}
const {
  title = 'El TPV para tu tienda, simple y en regla',
  subtitle = 'Cobra, emite tickets y facturas, controla inventario y cumple con VeriFactu.',
  ctaText = 'Probar gratis', ctaHref = '#contacto',
  cta2Text = 'Ver precios', cta2Href = '#precios',
  imageSrc = '/assets/features/welcome_page.png',
  splineUrl = '',
  imageWidth = 1200,
  imageHeight = 720
} = Astro.props as Props;

/**
 * Rendimiento:
 * - fetchpriority="high" para LCP
 * - width/height para evitar CLS
 * - <picture> con WebP (requiere el .webp generado)
 * - sizes para elegir tamaño óptimo según viewport
 */
const webpCandidate = imageSrc.endsWith('.png')
  ? imageSrc.replace(/\.png$/i, '.webp')
  : imageSrc.endsWith('.jpg') || imageSrc.endsWith('.jpeg')
    ? imageSrc.replace(/\.(jpg|jpeg)$/i, '.webp')
    : '';

// Columna de la imagen ≈ 56-58vw en desktop (2 columnas, 0.85fr/1.15fr)
const sizes = '(min-width: 981px) 56vw, 92vw';
---
<section class="diorama-page" aria-label="Hero estilo diorama">
  <div class="wrap">
    <div class="hero-card">
      <div class="hero-grid">
        <div>
          <h1>{title}</h1>
          <p class="lead">{subtitle}</p>
          <div class="ctas">
            <a class="btn primary1 center-cta" href={ctaHref}>{ctaText}</a>
            <a class="btn primary2 center-cta" href={cta2Href}>{cta2Text}</a>
          </div>
          <div class="bullets">
            <div>• Cobro rápido: efectivo y tarjeta</div>
            <div>• Facturas al instante por email</div>
            <div>• Cumplimiento VeriFactu</div>
          </div>
        </div>

        <div class="stage" role="img" aria-label="Escena tipo diorama con TPV">
          <div class="media">
            {splineUrl
              ? (
                  <div class="hero-media-box" style={`aspect-ratio:${imageWidth}/${imageHeight};`}>
                    <iframe
                      src={splineUrl}
                      title="Diorama 3D"
                      frameborder="0"
                      allow="autoplay; fullscreen"
                      loading="lazy"
                      style="width:100%; height:100%; border:0;"
                    ></iframe>
                  </div>
                )
              : (
                  <div class="hero-media-box" style={`aspect-ratio:${imageWidth}/${imageHeight};`}>
                    <picture style="display:block; width:100%; height:100%;">
                      {webpCandidate && <source srcset={webpCandidate} type="image/webp" />}
                      <img
                        src={imageSrc}
                        alt="TPV en mostrador"
                        width={imageWidth}
                        height={imageHeight}
                        fetchpriority="high"
                        decoding="async"
                        sizes={sizes}
                        style="width:100%; height:100%; object-fit:cover;"
                      />
                    </picture>
                  </div>
                )
            }
          </div>
        </div>
      </div>

      <svg class="waves" viewBox="0 0 1440 160" preserveAspectRatio="none" aria-hidden="true">
        <path class="wave-path" d="M0,80 C160,20 320,20 480,80 C640,140 800,140 960,80 C1120,20 1280,20 1440,80 L1440,160 L0,160 Z"></path>
      </svg>
    </div>
  </div>

  <script is:inline>
    (() => {
      const reduce = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      const hero = document.querySelector('.diorama-page');
      const path = document.querySelector('.waves .wave-path');
      if (!path || !hero || reduce) return;

      const io = new IntersectionObserver((entries) => {
        for (const e of entries) {
          if (e.isIntersecting) path.classList.add('is-animating');
          else path.classList.remove('is-animating');
        }
      }, { threshold: 0.15 });

      io.observe(hero);
    })();
  </script>
</section>