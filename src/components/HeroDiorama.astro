---
import "@styles/diorama.css";

interface Props{
  title?: string; subtitle?: string;
  ctaText?: string; ctaHref?: string; cta2Text?: string; cta2Href?: string;
  imageSrc?: string;
  splineUrl?: string;
}
const {
  title = 'El TPV para tu tienda, simple y en regla',
  subtitle = 'Cobra, emite tickets y facturas, controla inventario y cumple con VeriFactu.',
  ctaText = 'Probar gratis', ctaHref = '#contacto',
  cta2Text = 'Ver precios', cta2Href = '#precios',
  imageSrc = '/images/tpv-diorama.jpg',
  splineUrl = ''
} = Astro.props as Props;
---
<section class="diorama-page" aria-label="Hero estilo diorama">
  <div class="wrap">
    <div class="hero-card">
      <div class="hero-grid">
        <div>
          <h1>{title}</h1>
          <p class="lead">{subtitle}</p>
          <div class="ctas">
            <a class="btn primary1 center-cta" href={ctaHref}>{ctaText}</a>
            <a class="btn primary2 center-cta" href={cta2Href}>{cta2Text}</a>
          </div>
          <div class="bullets">
            <div>• Cobro rápido: efectivo y tarjeta</div>
            <div>• Facturas al instante por email</div>
            <div>• Cumplimiento VeriFactu</div>
          </div>
        </div>

        <div class="stage" role="img" aria-label="Escena tipo diorama con TPV">
          <div class="media">
            {splineUrl
              ? <iframe src={splineUrl} title="Diorama 3D" frameborder="0" allow="autoplay; fullscreen" loading="lazy"></iframe>
              : <img src={imageSrc} alt="TPV en mostrador" tabindex="0" />
            }
          </div>
        </div>
      </div>

      <svg class="waves" viewBox="0 0 1440 160" preserveAspectRatio="none" aria-hidden="true">
        <path class="wave-path" d="M0,80 C160,20 320,20 480,80 C640,140 800,140 960,80 C1120,20 1280,20 1440,80 L1440,160 L0,160 Z"></path>
      </svg>
    </div>
  </div>

  <script is:inline>
    (() => {
      const reduce = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      const hero = document.querySelector('.diorama-page');
      const path = document.querySelector('.waves .wave-path');
      const img = hero?.querySelector('.stage img');
      if (!img) return;

      // Animación ola
      if (!reduce && path && hero) {
        const io = new IntersectionObserver((entries) => {
          entries.forEach(e => {
            if (e.isIntersecting) path.classList.add('is-animating');
            else path.classList.remove('is-animating');
          });
        }, { threshold: 0.15 });
        io.observe(hero);
      }

      if (reduce) return;

      const mqHover = window.matchMedia('(hover:hover) and (pointer:fine)');
      let overlay: HTMLElement | null = null;

      function ensureOverlay() {
        overlay = document.querySelector('.zoom-overlay') as HTMLElement;
        if (!overlay) {
          overlay = document.createElement('div');
            overlay.className = 'zoom-overlay';
          document.body.appendChild(overlay);
        }
      }

      function openZoom() {
        if (document.body.classList.contains('zoom-global-active')) return;
        ensureOverlay();
        const clone = img.cloneNode(true) as HTMLImageElement;
        clone.classList.add('zoomed-focus');
        clone.removeAttribute('tabindex'); // evitar doble foco
        overlay!.innerHTML = '';
        overlay!.appendChild(clone);
        document.body.classList.add('zoom-global-active');

        const close = () => closeZoom();
        overlay!.addEventListener('click', close, { once:true });
        clone.addEventListener('click', close, { once:true });
        document.addEventListener('keydown', escHandler);
      }

      function closeZoom() {
        if (!document.body.classList.contains('zoom-global-active')) return;
        document.body.classList.remove('zoom-global-active');
        if (overlay) overlay.innerHTML = '';
        document.removeEventListener('keydown', escHandler);
      }

      function escHandler(ev: KeyboardEvent) {
        if (ev.key === 'Escape') closeZoom();
      }

      // Click para abrir/cerrar
      if (mqHover.matches) {
        img.addEventListener('click', () => {
          if (document.body.classList.contains('zoom-global-active')) {
            closeZoom();
          } else {
            openZoom();
          }
        });
      }

      // Teclado: Enter/Espacio
      img.addEventListener('keydown', (ev) => {
        if (ev.key === 'Enter' || ev.key === ' ') {
          ev.preventDefault();
          if (document.body.classList.contains('zoom-global-active')) closeZoom();
          else openZoom();
        } else if (ev.key === 'Escape') {
          closeZoom();
        }
      });

      // Si pierde foco y está abierto (poco común), cerramos
      img.addEventListener('blur', () => {
        if (document.body.classList.contains('zoom-global-active')) closeZoom();
      });
    })();
  </script>
</section>