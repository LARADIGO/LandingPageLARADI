---
import "@styles/global.css";
import ThemeToggle from '@components/ThemeToggle.astro';
import CookieConsent from '@components/CookieConsent.astro';
import SiteFooter from '@components/SiteFooter.astro';

const {
  title = "TePeuVe",
  description = "Interfaz clara, cobros en segundos y control total de inventario. Funciona en PC y tablet.",
  image = "/assets/og-image.svg",
} = Astro.props;

const contactEndpoint = import.meta.env.PUBLIC_CONTACT_ENDPOINT || "";
---
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport"
          content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover, user-scalable=no" />
    <title>{title}</title>
    <meta name="description" content={description} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={image} />
    <meta name="theme-color" content="#ffffff" />
    <link rel="icon" href="/logo.png" type="image/png" />

    <!-- DNS + Preconnect a fuentes y API -->
    <link rel="dns-prefetch" href="https://fonts.googleapis.com" />
    <link rel="dns-prefetch" href="https://fonts.gstatic.com" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    {contactEndpoint && <link rel="preconnect" href={new URL(contactEndpoint).origin} />}

    <!-- Preload hero LCP (imagen clara por defecto) -->
    <link rel="preload" as="image" href="/assets/features/welcome_page.png" fetchpriority="high" />

    <!-- Fuentes (display=swap) -->
    <link
      href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&family=Space+Grotesk:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <script is:inline>
      window.dataLayer = window.dataLayer || [];
      function gtag(){ dataLayer.push(arguments); }
      gtag('consent', 'default', {
        ad_user_data: 'denied',
        ad_personalization: 'denied',
        ad_storage: 'denied',
        analytics_storage: 'denied',
        functionality_storage: 'granted',
        security_storage: 'granted'
      });
    </script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-6QB73LYVYN"></script>
    <script is:inline>
      function gtag(){ dataLayer.push(arguments); }
      gtag('js', new Date());
      gtag('config', 'G-6QB73LYVYN', { anonymize_ip:true, send_page_view:true, transport_type:'beacon' });
      if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
        gtag('config', 'G-6QB73LYVYN', { debug_mode:true });
      }
    </script>

    <!-- Variable global para el script de contacto -->
    <script is:inline>
      window.CONTACT_ENDPOINT = {JSON.stringify(contactEndpoint)};
      console.log('[contact][BOOT] CONTACT_ENDPOINT:', window.CONTACT_ENDPOINT || '(vacío)');
    </script>
  </head>
  <body>
    <header class="site-header" role="banner">
      <div class="container header-inner">
        <a href="/" class="brand">TePeuVe</a>

        <input id="nav-toggle" type="checkbox" class="nav-toggle" aria-label="Abrir menú" />
        <label for="nav-toggle" class="nav-toggle-btn">
          <span></span><span></span><span></span>
        </label>

        <nav class="nav" aria-label="Menú principal">
          <a href="#caracteristicas">Funcionalidades</a>
          <a href="#verifactu">VeriFactu</a>
          <a href="#precios">Precios</a>
          <a href="#sobre">Quiénes somos</a>
          <a href="#contacto" class="btn btn-sm cta-pastel">Probar gratis</a>
          <ThemeToggle />
        </nav>
      </div>
    </header>

    <main id="inicio">
      <slot />
    </main>

    <SiteFooter />

    <script is:inline>
    (() => {
      // Sombra al hacer scroll (mantiene funcionalidad original)
      const header = document.querySelector('.site-header');
      const onScroll = () => {
        if (window.scrollY > 8) header.classList.add('is-scrolled');
        else header.classList.remove('is-scrolled');
      };
      onScroll();
      window.addEventListener('scroll', onScroll, { passive:true });

      // Auto-hover móvil: anima al entrar y vuelve al estado original (no se queda pegado)
      const hasHover = window.matchMedia('(hover:hover) and (pointer:fine)').matches;
      const reduceMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      if (!hasHover && !reduceMotion) {
        const cards = document.querySelectorAll('.card');
        const HOVER_DURATION = 900;
        const OBS_THRESHOLD = 0.35;

        const cardObserver = new IntersectionObserver((entries) => {
          entries.forEach((entry) => {
            const card = entry.target;
            if (!entry.isIntersecting) {
              card.classList.remove('card-auto-hover');
              card.dataset.animating = '0';
              if (card._hoverTimer) {
                clearTimeout(card._hoverTimer);
                card._hoverTimer = null;
              }
              return;
            }
            if (entry.isIntersecting && card.dataset.animating !== '1') {
              card.dataset.animinating = '1';
              card.dataset.animating = '1';
              card.classList.add('card-auto-hover');
              if (card._hoverTimer) { clearTimeout(card._hoverTimer); }
              card._hoverTimer = setTimeout(() => {
                card.classList.remove('card-auto-hover');
                card.dataset.animating = '0';
                card._hoverTimer = null;
              }, HOVER_DURATION);
            }
          });
        }, {
          threshold: OBS_THRESHOLD,
          rootMargin: '0px 0px -10% 0px'
        });

        cards.forEach((c) => cardObserver.observe(c));
      }

      // Interacción táctil en pricing
      const hasHoverFine = window.matchMedia('(hover:hover) and (pointer:fine)').matches;
      if (!hasHoverFine) {
        const pricingGrid = document.querySelector('.pricing-grid');
        if (pricingGrid) {
          pricingGrid.addEventListener('click', (ev) => {
            const card = ev.target.closest('.pricing-card');
            if (!card) {
              pricingGrid.classList.remove('touch-active');
              pricingGrid.querySelectorAll('.pricing-card.is-active').forEach(c => c.classList.remove('is-active'));
              return;
            }
            pricingGrid.classList.add('touch-active');
            pricingGrid.querySelectorAll('.pricing-card.is-active').forEach(c => c.classList.remove('is-active'));
            card.classList.add('is-active');
          });
          document.addEventListener('click', (ev) => {
            if (!pricingGrid) return;
            if (ev.target.closest('.pricing-grid')) return;
            pricingGrid.classList.remove('touch-active');
            pricingGrid.querySelectorAll('.pricing-card.is-active').forEach(c => c.classList.remove('is-active'));
          });
        }
      }

      // Ripple en botones (microinteracción)
      const prefersReduce = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      if (!prefersReduce) {
        document.addEventListener('click', (e) => {
          const btn = e.target && e.target.closest ? e.target.closest('.btn') : null;
          if (!btn || btn.hasAttribute('disabled')) return;
          const rect = btn.getBoundingClientRect();
          const x = (e.clientX ?? (rect.left + rect.width/2)) - rect.left;
          const y = (e.clientY ?? (rect.top + rect.height/2)) - rect.top;
          const size = Math.max(rect.width, rect.height) * 1.65;

          const span = document.createElement('span');
          span.className = 'ripple';
          span.style.setProperty('--ripple-x', x + 'px');
          span.style.setProperty('--ripple-y', y + 'px');
          span.style.setProperty('--ripple-size', size + 'px');

          if (getComputedStyle(btn).position === 'static') {
            btn.style.position = 'relative';
          }
          btn.appendChild(span);
          span.addEventListener('animationend', () => span.remove(), { once:true });
        }, { passive: true });
      }

      // ============== Rendimiento: carga diferida de contact.js ==============
      // Sólo se carga si existe el formulario (páginas con contacto), usando idle.
      const loadContactScript = () => {
        if (!document.getElementById('contact-form')) return;
        const s = document.createElement('script');
        s.type = 'module';
        s.src = '/scripts/contact.js';
        s.defer = true;
        document.body.appendChild(s);
      };
      if ('requestIdleCallback' in window) {
        requestIdleCallback(loadContactScript, { timeout: 3000 });
      } else {
        setTimeout(loadContactScript, 900);
      }
      // =======================================================================
    })();
    </script>

    <!-- GA4 adicional (si tuvieras eventos, puedes añadirlos después; mantenemos ga4.js si existe) -->
    <script type="module" src="/scripts/ga4.js"></script>

    <CookieConsent />
  </body>
</html>