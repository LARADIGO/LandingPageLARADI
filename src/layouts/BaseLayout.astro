---
import "@styles/global.css";
import "@styles/intro-splash.css";
import IntroSplash from "@components/IntroSplash.astro";
import ThemeToggle from '@components/ThemeToggle.astro';
import CookieConsent from '@components/CookieConsent.astro';
import SiteFooter from '@components/SiteFooter.astro';

const {
  title = "TePeuVe",
  description = "Interfaz clara, cobros en segundos y control total de inventario. Funciona en PC y tablet.",
  image = "/assets/og-image.svg",
  robots = "index,follow"
} = Astro.props;

const contactEndpoint = import.meta.env.PUBLIC_CONTACT_ENDPOINT || "";

const origin = Astro.url.origin;
const canonicalUrl = origin + Astro.url.pathname;
const ogImageUrl = new URL(image, origin).href;
const logoUrl = new URL('/logo.png', origin).href;
const siteName = 'TePeuVe';

const jsonLdHead = JSON.stringify([
  {
    "@context":"https://schema.org",
    "@type":"Organization",
    "name": siteName,
    "url": origin,
    "logo": logoUrl,
    "contactPoint": [{
      "@type":"ContactPoint",
      "contactType":"sales",
      "url": origin + "/#contacto",
      "availableLanguage": ["es"]
    }]
  },
  {
    "@context":"https://schema.org",
    "@type":"WebSite",
    "name": siteName,
    "url": origin
  },
  {
    "@context":"https://schema.org",
    "@type":"SoftwareApplication",
    "name":"TePeuVe TPV",
    "applicationCategory":"BusinessApplication",
    "operatingSystem":"Web",
      "offers": {
      "@type":"Offer",
      "price":"9.90",
      "priceCurrency":"EUR"
    }
  }
]);
---
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport"
          content="width=device-width, initial-scale=1, maximum-scale=5, viewport-fit=cover" />
    <title>{title}</title>
    <meta name="description" content={description} />
    <meta name="robots" content={robots} />
    <link rel="canonical" href={canonicalUrl} />
    <link rel="alternate" href={canonicalUrl} hreflang="es" />
    <link rel="alternate" href={canonicalUrl} hreflang="x-default" />

    <meta property="og:type" content="website" />
    <meta property="og:locale" content="es_ES" />
    <meta property="og:site_name" content={siteName} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:image" content={ogImageUrl} />
    <meta property="og:image:secure_url" content={ogImageUrl} />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:image:alt" content="TePeuVe - TPV para tu tienda" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={ogImageUrl} />

    <meta name="theme-color" content="#ffffff" />

    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16.png" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
    <link rel="icon" href="/favicon.ico" />
    <link rel="mask-icon" href="/logo.svg" color="#e8caa6" />

    <link rel="dns-prefetch" href="https://fonts.googleapis.com" />
    <link rel="dns-prefetch" href="https://fonts.gstatic.com" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

    <!-- Fuentes globales existentes -->
    <link
      href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&family=Space+Grotesk:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <!-- Nuevas fuentes SOLO para el splash (futurista/cyber) -->
    <link
      href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400..900&family=Share+Tech+Mono&family=Saira+Stencil+One&family=Chakra+Petch:wght@500;700&display=swap"
      rel="stylesheet"
    />

    <script type="application/ld+json" is:inline set:html={jsonLdHead}></script>

    <script is:inline>
      window.dataLayer = window.dataLayer || [];
      function gtag(){ dataLayer.push(arguments); }
      gtag('consent', 'default', {
        ad_user_data: 'denied',
        ad_personalization: 'denied',
        ad_storage: 'denied',
        analytics_storage: 'denied',
        functionality_storage: 'granted',
        security_storage: 'granted'
      });
    </script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-6QB73LYVYN"></script>
    <script is:inline>
      function gtag(){ dataLayer.push(arguments); }
      gtag('js', new Date());
      gtag('config', 'G-6QB73LYVYN', { anonymize_ip:true, send_page_view:true, transport_type:'beacon' });
      if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
        gtag('config', 'G-6QB73LYVYN', { debug_mode:true });
      }
    </script>

    <script is:inline>
      window.CONTACT_ENDPOINT = {JSON.stringify(contactEndpoint)};
    </script>
  </head>
  <body>
    <a href="#inicio" class="skip-link">Saltar al contenido</a>
    
    <!-- Pantalla de introducción -->
    <IntroSplash
      firstMessage="Bienvenido al TPV del futuro..."
      secondMessage="Te presentamos TePeuVe"
      secondTypewriter={true}
      oncePerSession={false}
      theme="auto"
      durationMultiplier={1}
      explodeDelay={620}
      explodeDuration={680}
      fireworksDelayAfterSecond={100}
      fireworksDuration={2000}
      flashDuration={300}
      fireworksBurstsTotal={12}
      fireworksNearCenter={5}
      fireworksSpreadBase={140}
      fireworksSpreadVariance={240}
      fireworksRandomScreen={true}
      fireworksParticlesMin={24}
      fireworksParticlesMax={42}
      fireworksTimelineSpacing={220}
      fireworksAllowOverlap={false}
      fireworksParticleSizeMin={5}
      fireworksParticleSizeMax={16}
      fireworksTrailEnabled={true}
      fireworksTrailThickness={3}
      fireworksTrailLengthFactor={1.15}
      fireworksTrailFadeExtra={450}
      backgroundFadeDelay={1300}
      backgroundFadeDuration={3300}
      backgroundFinalOpacity={0.3}
      splashFontPreset="stencil"
      skipEnabled={true}
      logoBurstEnabled={true}
      logoRiseDuration={900}
      logoExpandDuration={500}
      logoDelayBeforeRise={50}
      logoShowDelay={140}
      logoFinalScale={0.95}
      logoCircleStableScale={0.50}
      logoCircleSize={240}
      logoCircleExpandScale={1.5}
      logoSyncFireworks={false}
      logoElevateOffset={250}
      logoStyle="glass ring sparkle"
    />

    <header class="site-header" role="banner">
      <div class="container header-inner">
        <a href="/" class="brand" aria-label="Inicio - TePeuVe">
          <img src="/logo.png" alt="" class="logo-mark" width="40" height="40" decoding="async" />
          TePeuVe
        </a>

        <input id="nav-toggle" type="checkbox" class="nav-toggle" aria-label="Abrir menú" />
        <label for="nav-toggle" class="nav-toggle-btn">
          <span></span><span></span><span></span>
        </label>

        <nav class="nav" aria-label="Menú principal">
          <a href="#caracteristicas">Funcionalidades</a>
          <a href="#verifactu">VeriFactu</a>
          <a href="#precios">Precios</a>
          <a href="#sobre">Quiénes somos</a>
          <a href="#contacto" class="btn btn-sm cta-pastel">Probar gratis</a>
          <ThemeToggle />
        </nav>
      </div>
    </header>

    <main id="inicio" tabindex="-1">
      <slot />
    </main>

    <SiteFooter />

    <script is:inline>
    (() => {
      const header = document.querySelector('.site-header');
      const onScroll = () => {
        if (window.scrollY > 8) header.classList.add('is-scrolled');
        else header.classList.remove('is-scrolled');
      };
      onScroll();
      window.addEventListener('scroll', onScroll, { passive:true });

      const hasHover = window.matchMedia('(hover:hover) and (pointer:fine)').matches;
      const reduceMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      if (!hasHover && !reduceMotion) {
        const cards = document.querySelectorAll('.card');
        const HOVER_DURATION = 900;
        const OBS_THRESHOLD = 0.35;

        const cardObserver = new IntersectionObserver((entries) => {
          entries.forEach((entry) => {
            const card = entry.target;
            if (!entry.isIntersecting) {
              card.classList.remove('card-auto-hover');
              card.dataset.animating = '0';
              if (card._hoverTimer) {
                clearTimeout(card._hoverTimer);
                card._hoverTimer = null;
              }
              return;
            }
            if (entry.isIntersecting && card.dataset.animating !== '1') {
              card.dataset.animating = '1';
              card.classList.add('card-auto-hover');
              if (card._hoverTimer) { clearTimeout(card._hoverTimer); }
              card._hoverTimer = setTimeout(() => {
                card.classList.remove('card-auto-hover');
                card.dataset.animating = '0';
                card._hoverTimer = null;
              }, HOVER_DURATION);
            }
          });
        }, {
          threshold: OBS_THRESHOLD,
          rootMargin: '0px 0px -10% 0px'
        });

        cards.forEach((c) => cardObserver.observe(c));
      }

      const hasHoverFine = window.matchMedia('(hover:hover) and (pointer:fine)').matches;
      if (!hasHoverFine) {
        const pricingGrid = document.querySelector('.pricing-grid');
        if (pricingGrid) {
          pricingGrid.addEventListener('click', (ev) => {
            const card = ev.target.closest('.pricing-card');
            if (!card) {
              pricingGrid.classList.remove('touch-active');
              pricingGrid.querySelectorAll('.pricing-card.is-active').forEach(c => c.classList.remove('is-active'));
              return;
            }
            pricingGrid.classList.add('touch-active');
            pricingGrid.querySelectorAll('.pricing-card.is-active').forEach(c => c.classList.remove('is-active'));
            card.classList.add('is-active');
          });
          document.addEventListener('click', (ev) => {
            if (!pricingGrid) return;
            if (ev.target.closest('.pricing-grid')) return;
            pricingGrid.classList.remove('touch-active');
            pricingGrid.querySelectorAll('.pricing-card.is-active').forEach(c => c.classList.remove('is-active'));
          });
        }
      }

      const prefersReduce = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      if (!prefersReduce) {
        document.addEventListener('click', (e) => {
          const btn = e.target && e.target.closest ? e.target.closest('.btn') : null;
          if (!btn || btn.hasAttribute('disabled')) return;
          const rect = btn.getBoundingClientRect();
          const x = (e.clientX ?? (rect.left + rect.width/2)) - rect.left;
          const y = (e.clientY ?? (rect.top + rect.height/2)) - rect.top;
          const size = Math.max(rect.width, rect.height) * 1.65;

          const span = document.createElement('span');
          span.className = 'ripple';
          span.style.setProperty('--ripple-x', x + 'px');
          span.style.setProperty('--ripple-y', y + 'px');
          span.style.setProperty('--ripple-size', size + 'px');

          if (getComputedStyle(btn).position === 'static') {
            btn.style.position = 'relative';
          }
          btn.appendChild(span);
          span.addEventListener('animationend', () => span.remove(), { once:true });
        }, { passive: true });
      }

      const loadContactScript = () => {
        if (!document.getElementById('contact-form')) return;
        const s = document.createElement('script');
        s.type = 'module';
        s.src = '/scripts/contact.js';
        s.defer = true;
        document.body.appendChild(s);
      };
      if ('requestIdleCallback' in window) {
        requestIdleCallback(loadContactScript, { timeout: 3000 });
      } else {
        setTimeout(loadContactScript, 900);
      }
    })();
    </script>

    <script type="module" src="/scripts/ga4.js"></script>

    <CookieConsent />
  </body>
</html>