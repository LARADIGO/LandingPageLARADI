---
import BaseLayout from "@layouts/BaseLayout.astro";
import HeroDiorama from "@components/HeroDiorama.astro";
import FaqSection from "@components/FaqSection.astro";
import FeatureShowcaseDynamicRatio from "@components/FeatureShowcaseDynamicRatio.astro";
import AboutSection from "@components/AboutSection.astro";

const errCode = Astro.url.searchParams.get('contact_error') || '';
const messages: Record<string, string> = {
  MISSING_FIELDS: 'Rellena todos los campos.',
  INVALID_EMAIL: 'El email no parece v√°lido.',
  SERVER_NOT_CONFIGURED: 'Configuraci√≥n del correo incompleta.',
  SES_REJECTED: 'El correo fue rechazado por SES (sandbox o identidad).',
  SES_ACCESS_DENIED: 'Permisos SES insuficientes.',
  BAD_JSON: 'Formato de datos incorrecto.',
  UNSUPPORTED_MEDIA_TYPE: 'Formato de env√≠o no soportado.',
  INTERNAL_ERROR: 'Error interno. Int√©ntalo m√°s tarde.',
  METHOD_NOT_ALLOWED: 'M√©todo no permitido.'
};

const initialStatus = errCode ? (messages[errCode] || 'No se pudo enviar el mensaje.') : '';
const initialStatusClass = errCode ? 'status-error' : '';
---
<BaseLayout
  title="TePeuVe"
  description="Interfaz clara, cobros en segundos y control total de inventario. Funciona en PC y tablet."
>
  <HeroDiorama
    title="Software TPV sencillo para tiendas y peque√±os negocios"
    subtitle="Vende, gestiona tu inventario y emite tickets y facturas en segundos. TePeuVe es ligero, r√°pido y cumple con todas las exigencias de VeriFactu."
    ctaHref="#contacto"
    cta2Href="#precios"
    imageSrc="/assets/features/welcome_page.png"
    imageWidth={1200}
    imageHeight={720}
  />

  <section id="caracteristicas" class="section">
    <div class="container">
      <h2 class="h2 center">Caracter√≠sticas clave</h2>
      <p class="lead center max-680">Todo lo que necesitas para vender de forma sencilla y sin preocupaciones</p>

      <div class="features-list" role="list" data-features>
        <article class="feature-item" role="listitem" aria-labelledby="f-cobros" data-feature="cobros">
          <div class="feature-ico" aria-hidden="true">üí≥</div>
          <h3 id="f-cobros" class="feature-title">Gesti√≥n de cobros</h3>
        </article>

        <article class="feature-item" role="listitem" aria-labelledby="f-facturas" data-feature="facturas">
          <div class="feature-ico" aria-hidden="true">üßæ</div>
          <h3 id="f-facturas" class="feature-title">Facturas y tickets</h3>
        </article>

        <article class="feature-item" role="listitem" aria-labelledby="f-informes" data-feature="informes">
          <div class="feature-ico" aria-hidden="true">üìà</div>
          <h3 id="f-informes" class="feature-title">Informes</h3>
        </article>

        <article class="feature-item" role="listitem" aria-labelledby="f-inventario" data-feature="inventario">
          <div class="feature-ico" aria-hidden="true">üì¶</div>
          <h3 id="f-inventario" class="feature-title">Inventario</h3>
        </article>

        <article class="feature-item" role="listitem" aria-labelledby="f-arqueo" data-feature="arqueo">
          <div class="feature-ico" aria-hidden="true">üíº</div>
          <h3 id="f-arqueo" class="feature-title">Arqueo de caja</h3>
          <span class="coin" aria-hidden="true"></span>
          <span class="coin" aria-hidden="true"></span>
          <span class="coin" aria-hidden="true"></span>
          <span class="coin" aria-hidden="true"></span>
        </article>

        <article class="feature-item" role="listitem" aria-labelledby="f-empleados" data-feature="empleados">
          <div class="feature-ico" aria-hidden="true">üë•</div>
          <h3 id="f-empleados" class="feature-title">Gesti√≥n de empleados</h3>
        </article>

        <article class="feature-item" role="listitem" aria-labelledby="f-verifactu" data-feature="verifactu">
          <div class="feature-ico" aria-hidden="true">üõ°Ô∏è</div>
          <h3 id="f-verifactu" class="feature-title">VeriFactu</h3>
        </article>

        <article class="feature-item" role="listitem" aria-labelledby="f-clientes" data-feature="clientes">
          <div class="feature-ico" aria-hidden="true">üéÅ</div>
          <h3 id="f-clientes" class="feature-title">Clientes y fidelizaci√≥n</h3>
        </article>
      </div>
    </div>
  </section>

  <FeatureShowcaseDynamicRatio
    defer={true}
    items={[
      {
        title:"Personalizaci√≥n Total de TePeuVe",
        text:"Adapta TePeuVe a tu forma de trabajar. Elige entre modo claro u oscuro, configura atajos y ajusta cada m√≥dulo a tu negocio.",
        carousel: true,
        carouselImages: [
          { light: "/assets/features/claro_oscuro.png", dark: "/assets/features/claro_oscuro.png", alt: "Modo claro y oscuro" },
          { light: "/assets/features/ajustes.png", dark: "/assets/features/ajustes_oscuro.png", alt: "Panel de ajustes" },
          { light: "/assets/features/ajustes2.png", dark: "/assets/features/ajustes_oscuro2.png", alt: "Ajustes avanzados" },
          { light: "/assets/features/fidelizacion.png", dark: "/assets/features/fidelizacion_oscuro.png", alt: "Fidelizaci√≥n de clientes" },
        ],
        alt:"Personalizaci√≥n del TPV",
        mediaAnim:"zoom-in",
        contentAnim:"slide-left",
        altBg:true,
        mediaWide: true,
        width: 1240,
        height: 760,
        autoplayMs: 4500,
        pauseOnHover: true
      },
      {
        title:"Gesti√≥n de Caja y Control de Efectivo",
        text:"Control autom√°tico de movimientos y arqueos r√°pidos. Compatible con caj√≥n portamonedas.",
        carousel: true,
        carouselImages: [
          { light: "/assets/features/arqueo_caja.png", dark: "/assets/features/arqueo_caja_oscuro.png", alt: "Arqueo de caja" },
          { light: "/assets/features/arqueo_caja2.png", dark: "/assets/features/arqueo_caja_oscuro2.png", alt: "Hist√≥rico de arqueos" },
          { light: "/assets/features/arqueo_caja3.png", dark: "/assets/features/arqueo_caja_oscuro3.png", alt: "Detalle de movimientos" },
        ],
        alt:"Gesti√≥n de caja",
        mediaAnim:"scale-up",
        contentAnim:"slide-right",
        altBg:true,
        mediaWide: true,
        width: 1240,
        height: 760,
        autoplayMs: 4500,
        pauseOnHover: true
      },
      {
        title:"Gesti√≥n de Empleados y Roles Personalizados",
        text:"Usuarios, roles, permisos granulares, PIN seguro y registro de ventas por empleado.",
        carousel: true,
        carouselImages: [
          { light: "/assets/features/empleados.png", dark: "/assets/features/empleados_oscuro.png", alt: "Listado de empleados" },
          { light: "/assets/features/empleados2.png", dark: "/assets/features/empleados_oscuro2.png", alt: "Roles y permisos" },
        ],
        alt:"Gesti√≥n de empleados",
        mediaAnim:"rotate-in",
        contentAnim:"lift-in",
        altBg:true,
        mediaWide: true,
        width: 1240,
        height: 760,
        autoplayMs: 4500,
        pauseOnHover: true
      },
      {
        title:"Informes claros y Personalizables",
        text:"Paneles filtrables y m√©tricas clave. Ajusta vistas y compara periodos para tomar decisiones.",
        carousel: true,
        carouselImages: [
          { light: "/assets/features/informes.png", dark: "/assets/features/informes_oscuro.png", alt: "Dashboard principal" },
          { light: "/assets/features/informes2.png", dark: "/assets/features/informes_oscuro2.png", alt: "Filtros de informes" },
          { light: "/assets/features/informes3.png", dark: "/assets/features/informes_oscuro3.png", alt: "Detalle por producto" },
          { light: "/assets/features/informes4.png", dark: "/assets/features/informes_oscuro4.png", alt: "Comparativas temporales" },
        ],
        alt:"Panel de informes",
        mediaAnim:"blur-in",
        contentAnim:"fade-in",
        altBg:true,
        mediaWide: true,
        width: 1240,
        height: 760,
        autoplayMs: 4500,
        pauseOnHover: true
      }
    ]}
  />

  <section id="verifactu" class="section alt verifactu-section defer">
    <div class="container">
      <h2 class="h2 center">VeriFactu</h2>
      <p class="lead center max-680">Prep√°rate para el sistema de verificaci√≥n fiscal y evita prisas en 2026.</p>
      <div class="cards cards-3">
        <article class="card"><div class="card-ico">üõ°Ô∏è</div><h3>¬øQu√© es VeriFactu?</h3><p>Sistema que garantiza integridad y trazabilidad de los registros de facturaci√≥n.</p></article>
        <article class="card"><div class="card-ico">üìÖ</div><h3>Entrada 2026</h3><p>Su obligatoriedad comienza en 2026; anticiparte reduce riesgos y costes.</p></article>
        <article class="card"><div class="card-ico">‚öôÔ∏è</div><h3>Impacto t√©cnico</h3><p>Secuencialidad, firma/hash, almacenamiento seguro y posible env√≠o telem√°tico.</p></article>
      </div>
      <p class="center" style="margin-top:26px;">
        <span class="vf-cta">
          <a class="btn btn-sm" href="https://www2.agenciatributaria.gob.es/wlpl/AVAC-CALC/InformadorVerifactu" target="_blank" rel="noopener">Documentaci√≥n AEAT</a>
          <img src="/assets/logos/aeat.svg" alt="Agencia Tributaria"
               width="28" height="28"
               loading="lazy"
               decoding="async"
               class="vf-cta__logo" />
        </span>
      </p>
    </div>
  </section>

  <section id="precios" class="section alt defer">
    <div class="container">
      <h2 class="h2 center">Escoge tu plan</h2>
      <div class="pricing-grid">
        <div class="pricing-card featured">
          <h3>Esencial</h3>
          <p class="price">9,90<span>‚Ç¨</span><span>/mes</span></p>
          <ul>
            <li>1 terminal</li>
            <li>Control y arqueo de caja</li>
            <li>Creaci√≥n de Productos y Categor√≠as</li>
            <li>Emisi√≥n y Personalizaci√≥n de Tickets y Facturas</li>
            <li>Soporte por Email</li>
          </ul>
          <a href="#contacto" class="btn btn-block">Contactar</a>
        </div>
        <div class="pricing-card featured">
          <h3>Avanzado</h3>
          <p class="price">14,90<span>‚Ç¨</span><span>/mes</span></p>
          <ul>
            <li>2 Terminales</li>
            <li>Plan Esencial</li>
            <li>Creaci√≥n y Personalizaci√≥n de empleados</li>
            <li>Control y gesti√≥n de Inventario</li>
            <li>Informes b√°sicos</li>
            <li>Soporte prioritario (&lt;24h)</li>
          </ul>
          <a href="#contacto" class="btn btn-block">Contactar</a>
        </div>
        <div class="pricing-card featured">
          <h3>Pro</h3>
          <p class="price">19,90<span>‚Ç¨</span><span>/mes</span></p>
          <ul>
            <li>+ de 2 Terminales</li>
            <li>Plan Avanzado</li>
            <li>Informes Avanzados y Personalizables</li>
            <li>Avisos de Bajo Stock</li>
            <li>Creaci√≥n de Clientes y Plan de Fidelizaci√≥n</li>
            <li>Soporte Premium (&lt;2h)</li>
          </ul>
          <a href="#contacto" class="btn btn-block">Contactar</a>
        </div>
      </div>

      <div class="pricing-note" role="note" aria-labelledby="pricing-note-heading">
        <div class="pricing-note__header">
          <span class="pricing-note__icon" aria-hidden="true">üß©</span>
          <span id="pricing-note-heading" class="pricing-note__lead">¬øNecesitas algo distinto?</span>
        </div>
        <p class="pricing-note__text">
          Si ninguno de estos planes se adapta a tu negocio, cont√°ctanos y te prepararemos un plan de TPV a medida:
          integraci√≥n de hardware, m√≥dulos personalizados, adaptaci√≥n VeriFactu y soporte cercano para tu crecimiento.
        </p>
      </div>
    </div>
  </section>

  <section id="sobre" class="section alt defer">
    <div class="container">
      <h2 class="h2 center">Qui√©nes somos</h2>
      <p class="lead center max-680">Somos un equipo peque√±o y cercano: desarrollamos este TPV pensando en las pymes para que dispongan de una herramienta completa y f√°cil de usar.</p>

      <div class="team-grid" role="list">
        <article class="team-member" role="listitem" aria-labelledby="team-1">
          <img class="team-photo" src="/assets/team/diego.jpg" alt="Foto de Diego" width="280" height="280" />
          <div class="team-body">
            <h3 id="team-1">Diego Miret</h3>
            <p class="muted">Ingeniero Inform√°tico</p>
            <p>Backend, perif√©ricos e infraestructura estable y escalable. Te ayudo con la parte t√©cnica.</p>
          </div>
        </article>

        <article class="team-member" role="listitem" aria-labelledby="team-2">
          <img class="team-photo" src="/assets/team/lara.jpg" alt="Foto de Lara" width="280" height="280" />
          <div class="team-body">
            <h3 id="team-2">Lara Gonz√°lez</h3>
            <p class="muted">Ingeniera de Telecomunicaciones</p>
            <p>UX, conectividad y adecuaci√≥n fiscal (VeriFactu). Asesor√≠a en hardware y flujo de caja.</p>
          </div>
        </article>
      </div>
    </div>
  </section>

  <FaqSection
    defer={true}
    title="Preguntas frecuentes"
    description="Resolvemos dudas sobre el TPV y VeriFactu."
    items={[
      { question: "¬øQu√© tipo de negocio puede usar TePeuVe?", answer: "Cualquier comercio que necesite un TPV r√°pido, intuitivo y con control de inventario, clientes y caja." },
      { question: "¬øQu√© necesito para que funcione?", answer: "Un PC o port√°til est√°ndar. Te asesoramos si necesitas hardware adicional." },
      { question: "¬øCompatibilidad con perif√©ricos?", answer: "Impresoras de tickets, lectores de c√≥digos, balanzas y caj√≥n portamonedas autom√°tico." },
      { question: "¬øHay permanencia?", answer: "No. Puedes cancelar en cualquier momento." },
      { question: "¬øPrueba gratuita?", answer: "S√≠, 30 d√≠as para evaluar el TPV sin compromiso." },
      { question: "¬øSoporte prioritario?", answer: "Disponible en planes Avanzado y Pro." },
      { question: "¬øCumplimiento VeriFactu?", answer: "Preparamos integridad, secuencialidad y trazabilidad exigidas." },
      { question: "¬øGesti√≥n de clientes?", answer: "Registro, historial de compras y fidelizaci√≥n configurable." },
      { question: "¬øDescuentos y promociones?", answer: "S√≠, reglas autom√°ticas y precios especiales." },
      { question: "¬øMulti‚Äëempleado y cajas?", answer: "Usuarios, roles personalizados y m√∫ltiples cajas." },
    ]}
    data-accordion="false"
    data-persist="true"
    data-icon="chevron"
    data-autoscroll="true"
    data-expand-collapse="true"
    data-counter-target="#faq-count"
    data-default-open="0"
    data-scroll-block="center"
    data-hash-prefix="faq-"
  />

  <section id="contacto" class="section alt defer">
    <div class="container">
      <h2 class="h2 center">Contacto</h2>
      <p class="lead center max-680">Cu√©ntanos tus dudas y te respondemos en menos de 24h.</p>
      <form id="contact-form"
            class="form"
            method="POST"
            action={import.meta.env.PUBLIC_CONTACT_ENDPOINT || ''}>
        <p class="hp" aria-hidden="true">
          <label>No rellenar: <input name="hp_field" autocomplete="off" tabindex="-1" /></label>
        </p>
        <div class="form-grid">
          <div>
            <label for="name">Nombre</label>
            <input id="name" name="name" type="text" required placeholder="Tu nombre" autocomplete="name" />
          </div>
          <div>
            <label for="email">Email</label>
            <input id="email"
                   name="email"
                   type="email"
                   required
                   placeholder="tu@ejemplo.com"
                   autocomplete="email"
                   inputmode="email"
                   pattern="^[^\\s@]+@[^\\s@]+\\.[^\\s@]{2,}$"
                   title="Introduce un email v√°lido (usuario@dominio.ext)" />
          </div>
          <div class="full">
            <label for="message">Mensaje</label>
            <textarea id="message" name="message" rows="4" required placeholder="¬øQu√© necesitas?" spellcheck="true"></textarea>
          </div>
          <div class="full consent-row">
            <label class="consent" for="privacy">
              <input id="privacy" name="privacy" type="checkbox" required />
              <span>Acepto la <a href="/politica-privacidad" target="_blank" rel="noopener">Pol√≠tica de privacidad</a>.</span>
            </label>
          </div>
          <div class="full captcha-wrap">
            <div class="cf-turnstile"
                 data-sitekey={import.meta.env.PUBLIC_TURNSTILE_SITEKEY || ''}
                 data-theme="auto"
                 data-size="normal"></div>
          </div>
        </div>
        <div id="contact-status"
             class={"muted " + initialStatusClass}
             role="status"
             aria-live="polite"
             style="min-height:1.2em;">
          {initialStatus}
        </div>
        <button type="submit" class="btn btn-lg" data-contact-submit>Enviar</button>
        <noscript><p class="muted">JavaScript desactivado: el CAPTCHA no se aplicar√°.</p></noscript>
      </form>
      {import.meta.env.PUBLIC_TURNSTILE_SITEKEY && (
        <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
      )}
    </div>
  </section>

  {errCode && (
    <script is:inline>
      const sec = document.getElementById('contacto');
      sec && sec.scrollIntoView({ behavior:'smooth', block:'center' });
      try {
        const u=new URL(location.href);
        u.searchParams.delete('contact_error');
        history.replaceState({},'',u.toString());
      } catch {}
    </script>
  )}

  <!-- Script animaciones caracter√≠sticas (reveal + replay fiable hover/click/touch) + detector 1 vs 2 l√≠neas -->
  <script is:inline>
    (() => {
      const prefersReduce = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      const list = document.querySelector('[data-features]');
      if (!list || prefersReduce) return;

      const items = Array.from(list.querySelectorAll('.feature-item'));

      // Mapa de clases para re-disparar las animaciones
      const featureClassMap = {
        cobros: 'fx-cobros',
        facturas: 'fx-facturas',
        informes: 'fx-informes',
        inventario: 'fx-inventario',
        arqueo: 'fx-arqueo',
        empleados: 'fx-empleados',
        verifactu: 'fx-verifactu',
        clientes: 'fx-clientes'
      };

      const runFeature = (el) => {
        const f = el.dataset.feature;
        const cls = featureClassMap[f];
        if (!cls) return;
        el.classList.remove(cls); // quitar anterior
        // Forzar reflow para poder rea√±adir la clase
        void el.offsetWidth;
        el.classList.add(cls);
      };

      // Reveal inicial con IO
      const io = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (!entry.isIntersecting) return;
          const el = entry.target;
          if (!el.classList.contains('revealed')) {
            el.classList.add('revealed');
            runFeature(el); // animaci√≥n inicial
          }
          io.unobserve(el);
        });
      }, { threshold: .35, rootMargin: '0px 0px -5% 0px' });

      items.forEach(it => io.observe(it));

      // Re-disparo por interacci√≥n (desktop hover, m√≥vil tap, foco teclado)
      items.forEach(el => {
        const trigger = () => runFeature(el);
        el.addEventListener('mouseenter', trigger);
        el.addEventListener('focus', trigger);
        el.addEventListener('click', trigger);
        el.addEventListener('touchstart', trigger, { passive: true });
      });

      // --- Detector 1 l√≠nea vs 2 l√≠neas para centrar o alinear arriba en m√≥vil ---
      let resizeT;
      const markMultilines = () => {
        items.forEach(it => {
          const title = it.querySelector('.feature-title');
          if (!title) return;
          const cs = getComputedStyle(title);
          let lh = parseFloat(cs.lineHeight);
          if (Number.isNaN(lh)) {
            const fs = parseFloat(cs.fontSize) || 14;
            lh = fs * 1.2; // fallback
          }
          const sh = title.scrollHeight;
          // Umbral ~1.6x para distinguir 2 l√≠neas (con clamp a 2)
          if (sh > lh * 1.6) {
            it.classList.add('is-multiline');
          } else {
            it.classList.remove('is-multiline');
          }
        });
      };

      // Ejecutar tras render y cuando cambie el layout
      const scheduleMark = () => requestAnimationFrame(markMultilines);
      scheduleMark();
      if (document.fonts && document.fonts.ready) {
        document.fonts.ready.then(markMultilines).catch(() => {});
      }
      window.addEventListener('resize', () => {
        clearTimeout(resizeT);
        resizeT = setTimeout(markMultilines, 120);
      }, { passive: true });
      window.addEventListener('orientationchange', () => setTimeout(markMultilines, 150), { passive: true });
    })();
  </script>
</BaseLayout>